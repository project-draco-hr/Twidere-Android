{
  if (context == null && source == null)   return null;
  Source ioSrc=null;
  BufferedSink sink=null;
  try {
    final String name=source.getName();
    if (isEmpty(name))     return null;
    final MimeTypeMap map=MimeTypeMap.getSingleton();
    final String extension=map.getExtensionFromMimeType(mimeType);
    if (extension == null)     return null;
    final String nameToSave=getFileNameWithExtension(name,extension);
    if (!destination.isDirectory() && !destination.mkdirs())     return null;
    final File saveFile=new File(destination,nameToSave);
    ioSrc=Okio.source(source);
    sink=Okio.buffer(Okio.sink(saveFile));
    sink.writeAll(ioSrc);
    sink.flush();
    if (mimeType != null) {
      MediaScannerConnection.scanFile(context,new String[]{saveFile.getPath()},new String[]{mimeType},null);
    }
    return saveFile;
  }
 catch (  final IOException e) {
    Log.w(LOGTAG,"Failed to save file",e);
    return null;
  }
 finally {
    Utils.closeSilently(sink);
    Utils.closeSilently(ioSrc);
  }
}
