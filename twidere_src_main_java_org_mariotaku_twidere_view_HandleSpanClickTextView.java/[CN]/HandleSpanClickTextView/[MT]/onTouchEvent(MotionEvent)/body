{
  final Spannable buffer=SpannableString.valueOf(getText());
  final int action=event.getAction();
  if (action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_DOWN) {
    int x=(int)event.getX();
    int y=(int)event.getY();
    x-=getTotalPaddingLeft();
    y-=getTotalPaddingTop();
    x+=getScrollX();
    y+=getScrollY();
    final Layout layout=getLayout();
    final int line=layout.getLineForVertical(y);
    final int off;
    try {
      off=layout.getOffsetForHorizontal(line,x);
    }
 catch (    IndexOutOfBoundsException e) {
      throw new IndexOutOfBoundsException("Line count " + layout.getLineCount() + ", line for y "+ y+ " is "+ line+ ", x is "+ x);
    }
    final float lineWidth=layout.getLineWidth(line);
    final ClickableSpan[] links=buffer.getSpans(off,off,ClickableSpan.class);
    if (links.length != 0 && x <= lineWidth) {
      final ClickableSpan link=links[0];
      if (action == MotionEvent.ACTION_UP) {
        setClickable(false);
        if (!mLongClickPerformed) {
          link.onClick(this);
        }
        return true;
      }
 else {
        mLongClickPerformed=false;
        setClickable(true);
      }
    }
 else {
      setClickable(false);
    }
  }
  return super.onTouchEvent(event);
}
