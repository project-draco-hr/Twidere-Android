{
  super.onCreate(savedInstanceState);
  mLocationManager=(LocationManager)getSystemService(Context.LOCATION_SERVICE);
  mPreferences=SharedPreferencesWrapper.getInstance(this,SHARED_PREFERENCES_NAME,Context.MODE_PRIVATE);
  mBottomSendButton=mPreferences.getBoolean(KEY_BOTTOM_SEND_BUTTON,false);
  mTwitterWrapper=getTwidereApplication().getTwitterWrapper();
  mResolver=getContentResolver();
  mValidator=new TwidereValidator(this);
  setContentView(getLayoutInflater().inflate(R.layout.activity_compose,null));
  setProgressBarIndeterminateVisibility(false);
  setFinishOnTouchOutside(false);
  mAccountIds=getAccountIds(this);
  if (mAccountIds.length <= 0) {
    final Intent intent=new Intent(INTENT_ACTION_TWITTER_LOGIN);
    intent.setClass(this,SignInActivity.class);
    startActivity(intent);
    finish();
    return;
  }
  mMenuBar.setIsBottomBar(true);
  mMenuBar.setMenuBarListener(this);
  mEditText.setOnEditorActionListener(mPreferences.getBoolean(KEY_QUICK_SEND,false) ? this : null);
  mEditText.addTextChangedListener(this);
  mAccountSelectorAdapter=new AccountSelectorAdapter(this);
  mMediaPreviewAdapter=new MediaPreviewAdapter(this);
  mMediasPreviewGrid.setAdapter(mMediaPreviewAdapter);
  final Intent intent=getIntent();
  if (savedInstanceState != null) {
    mSendAccountIds=savedInstanceState.getLongArray(EXTRA_ACCOUNT_IDS);
    mIsPossiblySensitive=savedInstanceState.getBoolean(EXTRA_IS_POSSIBLY_SENSITIVE);
    final ArrayList<ParcelableMediaUpdate> mediasList=savedInstanceState.getParcelableArrayList(EXTRA_MEDIAS);
    if (mediasList != null) {
      addMedias(mediasList);
    }
    mInReplyToStatus=savedInstanceState.getParcelable(EXTRA_STATUS);
    mInReplyToStatusId=savedInstanceState.getLong(EXTRA_STATUS_ID);
    mMentionUser=savedInstanceState.getParcelable(EXTRA_USER);
    mDraftItem=savedInstanceState.getParcelable(EXTRA_DRAFT);
    mShouldSaveAccounts=savedInstanceState.getBoolean(EXTRA_SHOULD_SAVE_ACCOUNTS);
    mOriginalText=savedInstanceState.getString(EXTRA_ORIGINAL_TEXT);
    mTempPhotoUri=savedInstanceState.getParcelable(EXTRA_TEMP_URI);
  }
 else {
    final int notificationId=intent.getIntExtra(EXTRA_NOTIFICATION_ID,-1);
    final long notificationAccount=intent.getLongExtra(EXTRA_NOTIFICATION_ACCOUNT,-1);
    if (notificationId != -1) {
      mTwitterWrapper.clearNotificationAsync(notificationId,notificationAccount);
    }
    if (!handleIntent(intent)) {
      handleDefaultIntent(intent);
    }
    if (mSendAccountIds == null || mSendAccountIds.length == 0) {
      final long[] idsInPrefs=ArrayUtils.parseLongArray(mPreferences.getString(KEY_COMPOSE_ACCOUNTS,null),',');
      final long[] intersection=ArrayUtils.intersection(idsInPrefs,mAccountIds);
      mSendAccountIds=intersection.length > 0 ? intersection : mAccountIds;
    }
    mOriginalText=ParseUtils.parseString(mEditText.getText());
  }
  if (!setComposeTitle(intent)) {
    setTitle(R.string.compose);
  }
  mMenuBar.inflate(R.menu.menu_compose);
  mSendView.setVisibility(mBottomSendButton ? View.GONE : View.VISIBLE);
  mBottomSendView.setVisibility(mBottomSendButton ? View.VISIBLE : View.GONE);
  mSendView.setOnClickListener(this);
  mBottomSendView.setOnClickListener(this);
  mSendView.setOnLongClickListener(this);
  mBottomSendView.setOnLongClickListener(this);
  final Menu menu=mMenuBar.getMenu();
  final Intent composeExtensionsIntent=new Intent(INTENT_ACTION_EXTENSION_COMPOSE);
  addIntentToMenu(this,menu,composeExtensionsIntent,MENU_GROUP_COMPOSE_EXTENSION);
  final Intent imageExtensionsIntent=new Intent(INTENT_ACTION_EXTENSION_EDIT_IMAGE);
  final MenuItem mediasMenuItem=menu.findItem(R.id.medias_menu);
  if (mediasMenuItem != null && mediasMenuItem.hasSubMenu()) {
    addIntentToMenu(this,mediasMenuItem.getSubMenu(),imageExtensionsIntent,MENU_GROUP_IMAGE_EXTENSION);
  }
  setMenu();
  updateAccountSelection();
  updateMediasPreview();
}
