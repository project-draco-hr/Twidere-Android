{
  super.onCreate(savedInstanceState);
  mLocationManager=(LocationManager)getSystemService(Context.LOCATION_SERVICE);
  mPreferences=SharedPreferencesWrapper.getInstance(this,SHARED_PREFERENCES_NAME,Context.MODE_PRIVATE,SharedPreferenceConstants.class);
  final TwidereApplication app=TwidereApplication.getInstance(this);
  mTwitterWrapper=app.getTwitterWrapper();
  mResolver=getContentResolver();
  mValidator=new TwidereValidator(this);
  mImageLoader=app.getMediaLoaderWrapper();
  setContentView(R.layout.activity_compose);
  setFinishOnTouchOutside(false);
  final long[] defaultAccountIds=Utils.getAccountIds(this);
  if (defaultAccountIds.length <= 0) {
    final Intent intent=new Intent(INTENT_ACTION_TWITTER_LOGIN);
    intent.setClass(this,SignInActivity.class);
    startActivity(intent);
    finish();
    return;
  }
  mMenuBar.setOnMenuItemClickListener(this);
  final boolean sendByEnter=mPreferences.getBoolean(KEY_QUICK_SEND);
  EditTextEnterHandler.attach(mEditText,new EnterListener(){
    @Override public void onHitEnter(){
      updateStatus();
    }
  }
,sendByEnter);
  mEditText.addTextChangedListener(new TextWatcher(){
    @Override public void beforeTextChanged(    final CharSequence s,    final int start,    final int count,    final int after){
    }
    @Override public void onTextChanged(    final CharSequence s,    final int start,    final int before,    final int count){
      setMenu();
      updateTextCount();
    }
    @Override public void afterTextChanged(    final Editable s){
    }
  }
);
  mEditText.setCustomSelectionActionModeCallback(this);
  mAccountSelectorContainer.setOnClickListener(this);
  mAccountSelectorButton.setOnClickListener(this);
  mLocationContainer.setOnClickListener(this);
  final LinearLayoutManager linearLayoutManager=new FixedLinearLayoutManager(this);
  linearLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);
  linearLayoutManager.setStackFromEnd(true);
  mAccountSelector.setLayoutManager(linearLayoutManager);
  mAccountSelector.addItemDecoration(new SpacingItemDecoration(this));
  mAccountsAdapter=new AccountIconsAdapter(this);
  mAccountSelector.setAdapter(mAccountsAdapter);
  mAccountsAdapter.setAccounts(ParcelableAccount.getAccounts(this,false,false));
  mMediaPreviewAdapter=new MediaPreviewAdapter(this);
  mMediaPreviewGrid.setAdapter(mMediaPreviewAdapter);
  final Intent intent=getIntent();
  if (savedInstanceState != null) {
    mAccountsAdapter.setSelectedAccountIds(savedInstanceState.getLongArray(EXTRA_ACCOUNT_IDS));
    mIsPossiblySensitive=savedInstanceState.getBoolean(EXTRA_IS_POSSIBLY_SENSITIVE);
    final ArrayList<ParcelableMediaUpdate> mediaList=savedInstanceState.getParcelableArrayList(EXTRA_MEDIA);
    if (mediaList != null) {
      addMedia(mediaList);
    }
    mInReplyToStatus=savedInstanceState.getParcelable(EXTRA_STATUS);
    mInReplyToStatusId=savedInstanceState.getLong(EXTRA_STATUS_ID);
    mMentionUser=savedInstanceState.getParcelable(EXTRA_USER);
    mDraftItem=savedInstanceState.getParcelable(EXTRA_DRAFT);
    mShouldSaveAccounts=savedInstanceState.getBoolean(EXTRA_SHOULD_SAVE_ACCOUNTS);
    mOriginalText=savedInstanceState.getString(EXTRA_ORIGINAL_TEXT);
  }
 else {
    final int notificationId=intent.getIntExtra(EXTRA_NOTIFICATION_ID,-1);
    final long notificationAccount=intent.getLongExtra(EXTRA_NOTIFICATION_ACCOUNT,-1);
    if (notificationId != -1) {
      mTwitterWrapper.clearNotificationAsync(notificationId,notificationAccount);
    }
    if (!handleIntent(intent)) {
      handleDefaultIntent(intent);
    }
    final long[] accountIds=mAccountsAdapter.getSelectedAccountIds();
    if (accountIds.length == 0) {
      final long[] idsInPrefs=TwidereArrayUtils.parseLongArray(mPreferences.getString(KEY_COMPOSE_ACCOUNTS,null),',');
      final long[] intersection=TwidereArrayUtils.intersection(idsInPrefs,defaultAccountIds);
      mAccountsAdapter.setSelectedAccountIds(intersection.length > 0 ? intersection : defaultAccountIds);
    }
    mOriginalText=ParseUtils.parseString(mEditText.getText());
  }
  if (!setComposeTitle(intent)) {
    setTitle(R.string.compose);
  }
  final Menu menu=mMenuBar.getMenu();
  getMenuInflater().inflate(R.menu.menu_compose,menu);
  ThemeUtils.wrapMenuIcon(mMenuBar);
  mSendView.setOnClickListener(this);
  mSendView.setOnLongClickListener(this);
  final Intent composeExtensionsIntent=new Intent(INTENT_ACTION_EXTENSION_COMPOSE);
  Utils.addIntentToMenu(this,menu,composeExtensionsIntent,MENU_GROUP_COMPOSE_EXTENSION);
  final Intent imageExtensionsIntent=new Intent(INTENT_ACTION_EXTENSION_EDIT_IMAGE);
  final MenuItem mediaMenuItem=menu.findItem(R.id.media_menu);
  if (mediaMenuItem != null && mediaMenuItem.hasSubMenu()) {
    Utils.addIntentToMenu(this,mediaMenuItem.getSubMenu(),imageExtensionsIntent,MENU_GROUP_IMAGE_EXTENSION);
  }
  setMenu();
  updateLocationState();
  updateMediaPreview();
  notifyAccountSelectionChanged();
}
