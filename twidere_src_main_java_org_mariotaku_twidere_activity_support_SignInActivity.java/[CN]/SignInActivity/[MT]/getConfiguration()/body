{
  final ConfigurationBuilder cb=new ConfigurationBuilder();
  final boolean enable_gzip_compressing=mPreferences.getBoolean(KEY_GZIP_COMPRESSING,false);
  final boolean ignore_ssl_error=mPreferences.getBoolean(KEY_IGNORE_SSL_ERROR,false);
  final boolean enable_proxy=mPreferences.getBoolean(KEY_ENABLE_PROXY,false);
  cb.setHostAddressResolverFactory(new TwidereHostResolverFactory(mApplication));
  cb.setHttpClientFactory(new OkHttpClientFactory(mApplication));
  if (TwitterContentUtils.isOfficialKey(this,mConsumerKey,mConsumerSecret)) {
    Utils.setMockOfficialUserAgent(this,cb);
  }
 else {
    Utils.setUserAgent(this,cb);
  }
  if (!isEmpty(mAPIUrlFormat)) {
    final String versionSuffix=mNoVersionSuffix ? null : "/1.1/";
    cb.setRestBaseURL(Utils.getApiUrl(mAPIUrlFormat,"api",versionSuffix));
    cb.setOAuthBaseURL(Utils.getApiUrl(mAPIUrlFormat,"api","/oauth/"));
    cb.setUploadBaseURL(Utils.getApiUrl(mAPIUrlFormat,"upload",versionSuffix));
    if (!mSameOAuthSigningUrl) {
      cb.setSigningRestBaseURL(DEFAULT_SIGNING_REST_BASE_URL);
      cb.setSigningOAuthBaseURL(DEFAULT_SIGNING_OAUTH_BASE_URL);
      cb.setSigningUploadBaseURL(DEFAULT_SIGNING_UPLOAD_BASE_URL);
    }
  }
  if (isEmpty(mConsumerKey) || isEmpty(mConsumerSecret)) {
    cb.setOAuthConsumerKey(TWITTER_CONSUMER_KEY_3);
    cb.setOAuthConsumerSecret(TWITTER_CONSUMER_SECRET_3);
  }
 else {
    cb.setOAuthConsumerKey(mConsumerKey);
    cb.setOAuthConsumerSecret(mConsumerSecret);
  }
  cb.setGZIPEnabled(enable_gzip_compressing);
  cb.setIgnoreSSLError(ignore_ssl_error);
  if (enable_proxy) {
    final String proxy_host=mPreferences.getString(KEY_PROXY_HOST,null);
    final int proxy_port=ParseUtils.parseInt(mPreferences.getString(KEY_PROXY_PORT,"-1"));
    if (!isEmpty(proxy_host) && proxy_port > 0) {
      cb.setHttpProxyHost(proxy_host);
      cb.setHttpProxyPort(proxy_port);
    }
  }
  return cb.build();
}
