{
  final int noTintColor, accentColor, backgroundTintColor;
  final boolean isColorTint;
  final Resources resources=((Activity)activity).getResources();
  final boolean isActionBarContext=isActionBarContext(view.getContext(),getActionBarContext((Activity)activity));
  final int themeResourceId=activity.getCurrentThemeResourceId();
  final boolean isDarkTheme=ThemeUtils.isDarkTheme(themeResourceId);
  final int backgroundColorApprox;
  if (!isActionBarContext) {
    accentColor=activity.getCurrentThemeColor();
    final int[] darkLightColors=new int[2];
    ThemeUtils.getDarkLightForegroundColors((Context)activity,activity.getCurrentThemeResourceId(),darkLightColors);
    noTintColor=TwidereColorUtils.getContrastYIQ(accentColor,ThemeUtils.ACCENT_COLOR_THRESHOLD,darkLightColors[0],darkLightColors[1]);
    backgroundTintColor=accentColor;
    backgroundColorApprox=isDarkTheme ? Color.BLACK : Color.WHITE;
    isColorTint=true;
  }
 else   if (isDarkTheme) {
    noTintColor=Color.WHITE;
    accentColor=activity.getCurrentThemeColor();
    backgroundTintColor=noTintColor;
    backgroundColorApprox=Color.BLACK;
    isColorTint=true;
  }
 else {
    final int actionBarColor=activity.getCurrentThemeColor();
    final int actionBarTheme=ThemeUtils.getActionBarThemeResource(activity.getThemeResourceId(),actionBarColor);
    final int[] darkLightColors=new int[2];
    ThemeUtils.getDarkLightForegroundColors((Context)activity,actionBarTheme,darkLightColors);
    accentColor=TwidereColorUtils.getContrastYIQ(actionBarColor,ThemeUtils.ACCENT_COLOR_THRESHOLD,darkLightColors[0],darkLightColors[1]);
    noTintColor=TwidereColorUtils.getContrastYIQ(accentColor,ThemeUtils.ACCENT_COLOR_THRESHOLD,darkLightColors[0],darkLightColors[1]);
    backgroundTintColor=accentColor;
    backgroundColorApprox=Color.WHITE;
    isColorTint=false;
  }
  final boolean isAccentOptimal=Math.abs(TwidereColorUtils.getYIQContrast(backgroundColorApprox,accentColor)) > 64;
  if (view instanceof TextView) {
    final TextView textView=(TextView)view;
    if (isAccentOptimal) {
      textView.setLinkTextColor(accentColor);
    }
  }
  if (view instanceof IThemeAccentView) {
    if (isAccentOptimal || !isColorTint) {
      ((IThemeAccentView)view).setAccentTintColor(ColorStateList.valueOf(accentColor));
    }
 else {
      final int defaultAccentColor=ThemeUtils.getColorFromAttribute(view.getContext(),R.attr.colorAccent,resources.getColor(R.color.branding_color));
      ((IThemeAccentView)view).setAccentTintColor(ColorStateList.valueOf(defaultAccentColor));
    }
  }
 else   if (view instanceof IThemeBackgroundTintView) {
    if (isAccentOptimal || !isColorTint) {
      ((IThemeBackgroundTintView)view).setBackgroundTintColor(ColorStateList.valueOf(backgroundTintColor));
    }
  }
 else   if (view instanceof TintableBackgroundView) {
    final TintableBackgroundView tintable=(TintableBackgroundView)view;
    if (isAccentOptimal || !isColorTint) {
      applyTintableBackgroundViewTint(tintable,accentColor,noTintColor,backgroundTintColor,isColorTint);
    }
  }
 else   if (view instanceof TwidereToolbar) {
    final Context context=view.getContext();
    if (context instanceof android.support.v7.internal.view.ContextThemeWrapper) {
      ((TwidereToolbar)view).setItemColor(ThemeUtils.getThemeForegroundColor(context,((ContextThemeWrapper)context).getThemeResId()));
    }
 else {
      ((TwidereToolbar)view).setItemColor(ThemeUtils.getThemeForegroundColor(context));
    }
  }
 else   if (view instanceof EditText) {
    if (isAccentOptimal || !isColorTint) {
      ViewCompat.setBackgroundTintList(view,ColorStateList.valueOf(backgroundTintColor));
    }
  }
 else   if (view instanceof ProgressBar) {
    if (isAccentOptimal || !isColorTint) {
      ViewSupport.setIndeterminateTintList((ProgressBar)view,ColorStateList.valueOf(accentColor));
      ViewSupport.setProgressTintList((ProgressBar)view,ColorStateList.valueOf(accentColor));
      ViewSupport.setProgressBackgroundTintList((ProgressBar)view,ColorStateList.valueOf(accentColor));
    }
  }
}
