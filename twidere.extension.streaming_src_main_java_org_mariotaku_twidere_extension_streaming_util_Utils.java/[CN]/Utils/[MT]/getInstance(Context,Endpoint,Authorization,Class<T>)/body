{
  final RestAPIFactory factory=new RestAPIFactory();
  final String userAgent;
  if (auth instanceof OAuthAuthorization) {
    final String consumerKey=((OAuthAuthorization)auth).getConsumerKey();
    final String consumerSecret=((OAuthAuthorization)auth).getConsumerSecret();
    final ConsumerKeyType officialKeyType=TwitterContentUtils.getOfficialKeyType(context,consumerKey,consumerSecret);
    if (officialKeyType != ConsumerKeyType.UNKNOWN) {
      userAgent=TwitterAPIUtils.getUserAgentName(officialKeyType);
    }
 else {
      userAgent=TwitterAPIUtils.getTwidereUserAgent(context);
    }
  }
 else {
    userAgent=TwitterAPIUtils.getTwidereUserAgent(context);
  }
  factory.setClient(getDefaultHttpClient(context));
  factory.setConverter(new TwitterConverter());
  factory.setEndpoint(endpoint);
  factory.setAuthorization(auth);
  factory.setRequestInfoFactory(new TwitterAPIUtils.TwidereRequestInfoFactory());
  factory.setHttpRequestFactory(new TwitterAPIUtils.TwidereHttpRequestFactory(userAgent));
  factory.setExceptionFactory(new TwitterAPIUtils.TwidereExceptionFactory());
  return factory.build(cls);
}
