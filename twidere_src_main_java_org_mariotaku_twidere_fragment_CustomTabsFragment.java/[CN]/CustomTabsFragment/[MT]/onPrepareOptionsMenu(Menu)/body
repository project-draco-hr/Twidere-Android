{
  final Resources res=getResources();
  final boolean hasOfficialKeyAccounts=Utils.hasAccountSignedWithOfficialKeys(getActivity());
  final boolean forcePrivateAPI=mPreferences.getBoolean(KEY_FORCE_USING_PRIVATE_APIS,false);
  final long[] accountIds=getAccountIds(getActivity());
  final MenuItem itemAdd=menu.findItem(R.id.add_submenu);
  if (itemAdd != null && itemAdd.hasSubMenu()) {
    final SubMenu subMenu=itemAdd.getSubMenu();
    subMenu.clear();
    final HashMap<String,CustomTabConfiguration> map=getConfiguraionMap();
    final List<Entry<String,CustomTabConfiguration>> tabs=new ArrayList<>(map.entrySet());
    Collections.sort(tabs,CustomTabConfigurationComparator.SINGLETON);
    for (    final Entry<String,CustomTabConfiguration> entry : tabs) {
      final String type=entry.getKey();
      final CustomTabConfiguration conf=entry.getValue();
      final boolean isOfficiakKeyAccountRequired=TAB_TYPE_ACTIVITIES_ABOUT_ME.equals(type) || TAB_TYPE_ACTIVITIES_BY_FRIENDS.equals(type);
      final boolean accountIdRequired=conf.getAccountRequirement() == CustomTabConfiguration.ACCOUNT_REQUIRED;
      final Intent intent=new Intent(INTENT_ACTION_ADD_TAB);
      intent.setClass(getActivity(),CustomTabEditorActivity.class);
      intent.putExtra(EXTRA_TYPE,type);
      intent.putExtra(EXTRA_OFFICIAL_KEY_ONLY,isOfficiakKeyAccountRequired);
      final MenuItem subItem=subMenu.add(conf.getDefaultTitle());
      final boolean disabledByNoAccount=accountIdRequired && accountIds.length == 0;
      final boolean disabledByNoOfficialKey=!forcePrivateAPI && isOfficiakKeyAccountRequired && !hasOfficialKeyAccounts;
      final boolean disabledByDuplicateTab=conf.isSingleTab() && isTabAdded(getActivity(),type);
      final boolean shouldDisable=disabledByDuplicateTab || disabledByNoOfficialKey || disabledByNoAccount;
      subItem.setVisible(!shouldDisable);
      subItem.setEnabled(!shouldDisable);
      final Drawable icon=ResourcesCompat.getDrawable(res,conf.getDefaultIcon(),null);
      subItem.setIcon(icon);
      subItem.setIntent(intent);
    }
  }
  final Activity activity=getActivity();
  if (activity instanceof BasePreferenceActivity) {
    final ActionBar actionBar=((BasePreferenceActivity)activity).getSupportActionBar();
    final int themeColor=((IThemedActivity)activity).getCurrentThemeColor();
    final int itemColor=TwidereColorUtils.getContrastYIQ(themeColor,ThemeUtils.ACCENT_COLOR_THRESHOLD);
    final int popupTheme=ThemeUtils.getActionBarPopupThemeRes(actionBar.getThemedContext());
    final int popupColor=ThemeUtils.getThemeForegroundColor(activity,popupTheme);
    ThemeUtils.applyColorFilterToMenuIcon(menu,itemColor,popupColor,0,Mode.SRC_ATOP);
  }
}
