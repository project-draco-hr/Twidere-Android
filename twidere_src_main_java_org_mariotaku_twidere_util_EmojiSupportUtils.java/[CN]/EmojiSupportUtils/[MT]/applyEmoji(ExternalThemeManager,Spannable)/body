{
  final ExternalThemeManager.Emoji emoji=manager.getEmoji();
  if (!emoji.isSupported())   return;
  CodePointArray array=new CodePointArray(text);
  for (int i=0, j=array.length(); i < j; i++) {
    final int codePoint=array.get(i);
    if (isEmoji(codePoint)) {
      final int idx=array.indexOfText(codePoint,i);
      if (idx == -1) {
        continue;
      }
      final int end=idx + Character.charCount(codePoint);
      final ExternalThemeManager.Emoji[] spans=text.getSpans(idx,end,ExternalThemeManager.Emoji.class);
      if (spans.length > 0)       continue;
      final Drawable drawable=emoji.getEmojiDrawableFor(codePoint);
      if (drawable == null)       continue;
      text.setSpan(new EmojiSpan(drawable),idx,end,Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
    }
  }
}
