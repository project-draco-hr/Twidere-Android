{
  final ExternalThemeManager.Emoji emoji=manager.getEmoji();
  if (!emoji.isSupported())   return;
  final CodePointArray array=new CodePointArray(text);
  for (int i=array.length() - 1; i >= 0; i--) {
    final int codePoint=array.get(i);
    if (isEmoji(codePoint)) {
      int arrayIdx=i, arrayEnd=i + 1;
      int textIdx=array.indexOfText(codePoint,i);
      if (textIdx == -1 || textIdx < textStart) {
        continue;
      }
      final int textEnd=textIdx + Character.charCount(codePoint);
      if (isRegionalIndicatorSymbol(codePoint)) {
        if (i > 0) {
          int prev=array.get(i - 1);
          if (isRegionalIndicatorSymbol(prev)) {
            textIdx-=Character.charCount(prev);
            arrayIdx--;
            i--;
          }
        }
      }
 else       if (isModifier(codePoint)) {
        if (i > 0) {
          int prev=array.get(i - 1);
          if (isEmoji(prev)) {
            textIdx-=Character.charCount(prev);
            arrayIdx--;
            i--;
          }
        }
      }
      if (textEnd > textStart + textLength)       continue;
      final EmojiSpan[] spans=text.getSpans(textIdx,textEnd,EmojiSpan.class);
      if (spans.length > 0)       continue;
      final Drawable drawable=emoji.getEmojiDrawableFor(array.subarray(arrayIdx,arrayEnd));
      if (drawable == null)       continue;
      text.setSpan(new EmojiSpan(drawable),textIdx,textEnd,Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
    }
  }
}
