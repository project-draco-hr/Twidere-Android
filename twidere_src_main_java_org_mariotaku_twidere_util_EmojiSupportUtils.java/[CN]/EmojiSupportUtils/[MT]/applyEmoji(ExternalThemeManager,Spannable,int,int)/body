{
  final ExternalThemeManager.Emoji emoji=manager.getEmoji();
  if (!emoji.isSupported())   return;
  final CodePointArray array=new CodePointArray(text);
  for (int i=array.length() - 1; i >= 0; i--) {
    final int codePoint=array.get(i);
    if (isEmoji(codePoint)) {
      int arrayIdx=i, arrayEnd=i + 1, arrayIdxOffset=0;
      int textIdx=array.indexOfText(codePoint,i), textIdxOffset=0;
      int indexOffset=0;
      if (textIdx == -1 || textIdx < textStart) {
        continue;
      }
      final int textEnd=textIdx + Character.charCount(codePoint);
      if (isRegionalIndicatorSymbol(codePoint)) {
        if (i > 0) {
          int prev=array.get(i - 1);
          if (isRegionalIndicatorSymbol(prev)) {
            arrayIdxOffset=-1;
            textIdxOffset=-Character.charCount(prev);
            indexOffset=-1;
          }
        }
      }
 else       if (isModifier(codePoint)) {
        if (i > 0) {
          int prev=array.get(i - 1);
          if (isEmoji(prev)) {
            arrayIdxOffset=-1;
            textIdxOffset=-Character.charCount(prev);
            indexOffset=-1;
          }
        }
      }
 else       if (isKeyCap(codePoint)) {
        if (i > 0) {
          int prev=array.get(i - 1);
          if (isPhoneNumberSymbol(prev)) {
            arrayIdxOffset=-1;
            textIdxOffset=-Character.charCount(prev);
            indexOffset=-1;
          }
        }
      }
      if (textEnd > textStart + textLength)       continue;
      EmojiSpan[] spans=text.getSpans(textIdx + textIdxOffset,textEnd,EmojiSpan.class);
      if (spans.length == 0) {
        Drawable drawable=emoji.getEmojiDrawableFor(array.subarray(arrayIdx + arrayIdxOffset,arrayEnd));
        if (drawable == null) {
          textIdxOffset=0;
          arrayIdxOffset=0;
          indexOffset=0;
          spans=text.getSpans(textIdx + textIdxOffset,textEnd,EmojiSpan.class);
          if (spans.length == 0) {
            drawable=emoji.getEmojiDrawableFor(array.subarray(arrayIdx + arrayIdxOffset,arrayEnd));
          }
        }
        if (drawable != null) {
          text.setSpan(new EmojiSpan(drawable),textIdx + textIdxOffset,textEnd,Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
        }
      }
      i+=indexOffset;
    }
  }
}
