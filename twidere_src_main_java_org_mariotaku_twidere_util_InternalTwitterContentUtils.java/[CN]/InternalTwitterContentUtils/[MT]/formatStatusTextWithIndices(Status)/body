{
  String text=status.getFullText();
  CodePointArray source;
  int[] range=null;
  if (text == null) {
    text=status.getText();
    source=new CodePointArray(text);
  }
 else {
    range=status.getDisplayTextRange();
    source=new CodePointArray(text);
  }
  final HtmlBuilder builder=new HtmlBuilder(source,false,true,false);
  parseEntities(builder,status);
  StatusTextWithIndices textWithIndices=new StatusTextWithIndices();
  final Pair<String,SpanItem[]> pair=builder.buildWithIndices();
  textWithIndices.text=pair.first;
  textWithIndices.spans=pair.second;
  if (range != null && range.length == 2) {
    final int length=source.length();
    textWithIndices.range=new int[2];
    textWithIndices.range[0]=source.charCount(0,range[0]);
    textWithIndices.range[1]=pair.first.length() - source.charCount(range[1],length);
  }
  return textWithIndices;
}
