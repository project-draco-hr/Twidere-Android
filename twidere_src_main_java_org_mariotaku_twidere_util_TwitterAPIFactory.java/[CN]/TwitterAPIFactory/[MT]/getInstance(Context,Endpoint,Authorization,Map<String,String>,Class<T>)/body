{
  final RestAPIFactory<TwitterException> factory=new RestAPIFactory<>();
  final String userAgent;
  if (auth instanceof OAuthAuthorization) {
    final String consumerKey=((OAuthAuthorization)auth).getConsumerKey();
    final String consumerSecret=((OAuthAuthorization)auth).getConsumerSecret();
    final ConsumerKeyType officialKeyType=TwitterContentUtils.getOfficialKeyType(context,consumerKey,consumerSecret);
    if (officialKeyType != ConsumerKeyType.UNKNOWN) {
      userAgent=getUserAgentName(context,officialKeyType);
    }
 else {
      userAgent=getTwidereUserAgent(context);
    }
  }
 else {
    userAgent=getTwidereUserAgent(context);
  }
  DependencyHolder holder=DependencyHolder.get(context);
  factory.setHttpClient(holder.getRestHttpClient());
  factory.setAuthorization(auth);
  factory.setEndpoint(endpoint);
  factory.setConstantPool(sConstantPoll);
  final TwitterConverterFactory converterFactory=new TwitterConverterFactory();
  factory.setRestConverterFactory(converterFactory);
  factory.setHttpRequestFactory(new TwidereHttpRequestFactory(userAgent));
  factory.setExceptionFactory(new TwidereExceptionFactory(converterFactory));
  return factory.build(cls);
}
