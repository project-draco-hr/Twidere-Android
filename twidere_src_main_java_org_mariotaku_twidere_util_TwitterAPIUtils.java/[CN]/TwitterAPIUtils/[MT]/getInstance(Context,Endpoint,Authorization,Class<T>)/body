{
  final RestAPIFactory factory=new RestAPIFactory();
  final String userAgent;
  if (auth instanceof OAuthAuthorization) {
    final String consumerKey=((OAuthAuthorization)auth).getConsumerKey();
    final String consumerSecret=((OAuthAuthorization)auth).getConsumerSecret();
    final ConsumerKeyType officialKeyType=TwitterContentUtils.getOfficialKeyType(context,consumerKey,consumerSecret);
    if (officialKeyType != ConsumerKeyType.UNKNOWN) {
      userAgent=Utils.getUserAgentName(officialKeyType);
    }
 else {
      userAgent=Utils.getTwidereUserAgent(context);
    }
  }
 else {
    userAgent=Utils.getTwidereUserAgent(context);
  }
  factory.setClient(getDefaultHttpClient(context));
  factory.setConverter(new TwitterConverter());
  factory.setEndpoint(endpoint);
  factory.setAuthorization(auth);
  factory.setRequestInfoFactory(new RequestInfo.Factory(){
    @Override public RequestInfo create(    RestMethodInfo methodInfo){
      final RestMethod method=methodInfo.getMethod();
      final String path=methodInfo.getPath();
      final List<Pair<String,String>> queries=new ArrayList<>(methodInfo.getQueries());
      final List<Pair<String,String>> forms=new ArrayList<>(methodInfo.getForms());
      final List<Pair<String,String>> headers=methodInfo.getHeaders();
      final List<Pair<String,TypedData>> parts=methodInfo.getParts();
      final Map<String,Object> extras=methodInfo.getExtras();
      final TypedData body=methodInfo.getBody();
      final List<Pair<String,String>> params=method.hasBody() ? forms : queries;
      addParameter(params,"include_cards",true);
      addParameter(params,"cards_platform","Android-12");
      addParameter(params,"include_entities",true);
      addParameter(params,"include_my_retweet",1);
      addParameter(params,"include_rts",1);
      addParameter(params,"include_reply_count",true);
      addParameter(params,"include_descendent_reply_count",true);
      return new RequestInfo(method.value(),path,queries,forms,headers,parts,extras,body);
    }
  }
);
  factory.setRequestFactory(new RestHttpRequest.Factory(){
    @Override public RestHttpRequest create(    @NonNull Endpoint endpoint,    @NonNull RequestInfo info,    @Nullable Authorization authorization){
      final String restMethod=info.getMethod();
      final String url=Endpoint.constructUrl(endpoint.getUrl(),info);
      final ArrayList<Pair<String,String>> headers=new ArrayList<>(info.getHeaders());
      if (authorization != null && authorization.hasAuthorization()) {
        headers.add(Pair.create("Authorization",authorization.getHeader(endpoint,info)));
      }
      headers.add(Pair.create("User-Agent",userAgent));
      return new RestHttpRequest(restMethod,url,headers,info.getBody(),null);
    }
  }
);
  factory.setExceptionFactory(new RestAPIFactory.ExceptionFactory(){
    @Override public Exception newException(    Throwable cause,    RestHttpResponse response){
      final TwitterException te=new TwitterException(cause);
      te.setResponse(response);
      return te;
    }
  }
);
  return factory.build(cls);
}
